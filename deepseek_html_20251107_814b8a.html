<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TomTom + NocoDB + Geo Frost</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #map { width: 100%; height: 100%; }

        :root {
            --frost-bg: rgba(255, 255, 255, 0.08);
            --frost-border: rgba(255, 255, 255, 0.18);
            --blur-intensity: 18px;
        }

        .frosted-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 80%;
            max-width: 300px;
            padding: 10px 16px;
            background:
              linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04)),
              var(--frost-bg);
            backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            border: 1px solid var(--frost-border);
            border-radius: 999px;
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.25),
              0 4px 15px rgba(0,0,0,0.45);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            z-index: 1000;
            cursor: pointer;
            transition: 0.2s ease-in-out;
        }

        .frosted-card:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow:
              inset 0 -3px 9px rgba(255,255,255,0.15),
              0 4px 25px rgba(255,255,255,0.2);
        }

        .frosted-card .user-image {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .frosted-card .user-display {
            font-size: 14px;
            letter-spacing: 0.3px;
            color: #000;
            text-align: center;
            white-space: nowrap;
        }

        /* Кнопка добавления ДПС - УВЕЛИЧЕННАЯ И КРАСНАЯ */
        #addDpsButton {
            position: absolute;
            top: 760px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px; /* Шире */
            padding: 18px 25px; /* Выше */
            background:
              linear-gradient(180deg, rgba(255,50,50,0.25), rgba(220,20,20,0.15)),
              rgba(255, 50, 50, 0.2); /* Красный фон */
            backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            border: 1px solid rgba(255, 80, 80, 0.4); /* Красная граница */
            border-radius: 20px;
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.3),
              0 6px 20px rgba(255, 50, 50, 0.3); /* Красная тень */
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            display: none;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        #addDpsButton:hover {
            transform: translateX(-50%) scale(1.08);
            background:
              linear-gradient(180deg, rgba(255,70,70,0.35), rgba(220,40,40,0.25)),
              rgba(255, 70, 70, 0.3);
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.4),
              0 8px 25px rgba(255, 70, 70, 0.4);
        }

        /* Стили для попапов маркеров в стиле уведомлений */
        .marker-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 80%;
            max-width: 300px;
            padding: 20px;
            background:
              linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)),
              var(--frost-bg);
            backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            border: 1px solid var(--frost-border);
            border-radius: 20px;
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.25),
              0 8px 25px rgba(0,0,0,0.6);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }

        .marker-popup.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .marker-popup .popup-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
        }

        .marker-popup .popup-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            color: #000;
        }

        .marker-popup .popup-message {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
            color: #000;
        }

        .marker-popup .popup-close {
            margin-top: 15px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: #000;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .marker-popup .popup-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #proximityNotification {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 16px;
            background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
            backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            border: 1px solid var(--frost-border);
            border-radius: 999px;
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.25),
              0 4px 15px rgba(0,0,0,0.45);
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            display: none;
            z-index: 1000;
        }

        /* Центральное уведомление для comm маркеров */
        #centerNotification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 360px;
            padding: 25px;
            background:
              linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08)),
              var(--frost-bg);
            backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            -webkit-backdrop-filter: blur(var(--blur-intensity)) saturate(150%);
            border: 1px solid var(--frost-border);
            border-radius: 20px;
            box-shadow:
              inset 0 -3px 9px rgba(0,0,0,0.25),
              0 8px 25px rgba(0,0,0,0.6);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            text-align: center;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease-in-out;
            pointer-events: none;
        }

        #centerNotification.active {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        #centerNotification .notification-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
        }

        #centerNotification .notification-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            color: #000;
        }

        #centerNotification .notification-message {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
            color: #000;
        }

        #centerNotification .notification-close {
            margin-top: 15px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: #000;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #centerNotification .notification-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Стили для модального окна разрешения звука */
        #soundPermissionModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .sound-permission-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            max-width: 320px;
            width: 85%;
            text-align: center;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .sound-permission-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #fff;
        }

        .sound-permission-card p {
            margin-bottom: 20px;
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .sound-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .sound-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .sound-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .sound-btn.yes {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .sound-btn.yes:hover {
            background: rgba(76, 175, 80, 0.5);
        }

        .sound-btn.no {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .sound-btn.no:hover {
            background: rgba(244, 67, 54, 0.5);
        }

        /* Модальное окно подтверждения добавления ДПС */
        #confirmDpsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            display: none;
        }

        .confirm-dps-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            max-width: 320px;
            width: 85%;
            text-align: center;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", Inter, sans-serif;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .confirm-dps-card h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #fff;
        }

        .confirm-dps-card p {
            margin-bottom: 20px;
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .confirm-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .confirm-btn.yes {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .confirm-btn.yes:hover {
            background: rgba(76, 175, 80, 0.5);
        }

        .confirm-btn.no {
            background: rgba(244, 67, 54, 0.3);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .confirm-btn.no:hover {
            background: rgba(244, 67, 54, 0.5);
        }

        .custom-marker {
            background: none;
            border: none;
        }

        .marker-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .user-marker {
            width: 60px; /* Увеличено на 20 пикселей */
            height: 60px; /* Увеличено на 20 пикселей */
        }
    </style>
</head>
<body>
<div id="map"></div>

<div id="geoButton" class="frosted-card">
    <img src="https://iimg.su/s/20/gm9WM5oxvBNSi8sDT6yoAlOz8gkprZHO28kRhkn6.png" alt="Аватар" class="user-image">
    <div class="user-display"><b>Разрешить геолокацию</b></div>
</div>

<!-- Кнопка добавления ДПС - КРАСНАЯ И УВЕЛИЧЕННАЯ -->
<div id="addDpsButton">Добавить ДПС</div>

<div id="proximityNotification"></div>

<!-- Центральное уведомление -->
<div id="centerNotification">
    <div class="notification-icon">
        <img src="https://iimg.su/s/20/gAVLBWCxVnvIUMz9ynbUbanhNSZljD6AOKod42GV.gif" alt="Иконка уведомления" style="width: 40px; height: 40px; border-radius: 0%;">
    </div>
    <div class="notification-title" id="centerNotificationTitle">Уведомление</div>
    <div class="notification-message" id="centerNotificationMessage"></div>
    <button class="notification-close">Понятно</button>
</div>

<!-- Попап для маркеров -->
<div id="markerPopup" class="marker-popup">
    <div class="popup-icon">
        <img src="https://iimg.su/s/20/gAVLBWCxVnvIUMz9ynbUbanhNSZljD6AOKod42GV.gif" alt="Иконка попапа" style="width: 40px; height: 40px; border-radius: 0%;">
    </div>
    <div class="popup-title" id="markerPopupTitle">ДПС</div>
    <div class="popup-message" id="markerPopupMessage"></div>
    <button class="popup-close">Понятно</button>
</div>

<!-- Модальное окно разрешения звука -->
<div id="soundPermissionModal" style="display: none;">
    <div class="sound-permission-card">
        <h3>Звуковые уведомления</h3>
        <p>Хотите получать звуковые уведомления при приближении к ДПС?</p>
        <div class="sound-buttons">
            <button class="sound-btn yes">ДА</button>
            <button class="sound-btn no">НЕТ</button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения добавления ДПС -->
<div id="confirmDpsModal">
    <div class="confirm-dps-card">
        <h3>Добавить ДПС</h3>
        <p>Вы уверены, что хотите отметить тут ДПС?</p>
        <div class="confirm-buttons">
            <button class="confirm-btn yes">ДА</button>
            <button class="confirm-btn no">ОТМЕНА</button>
        </div>
    </div>
</div>

<script>
const apiKey = "W1S6zYxW04QD9ShOWOMZnFVnKnyxcjkL";
const token = "wLQHYMSz2QYSR589VqZbzMGTyC5-4p0Gvtebgw7-";
const tableUrl = "https://nocodb.puzzlebot.top/api/v2/tables/mn15zqyrzy95xtp/records";

// Инициализация карты Leaflet с темным стилем TomTom
const map = L.map('map').setView([61.254051, 73.396197], 12);

// Добавление темного стиля TomTom Raster Tiles
L.tileLayer(`https://api.tomtom.com/map/1/tile/basic/night/{z}/{x}/{y}.png?key=${apiKey}&tileSize=512`, {
    attribution: '© TomTom',
    maxZoom: 22,
    tileSize: 512,
    zoomOffset: -1
}).addTo(map);

const userIcon = "https://s.iimg.su/s/05/g0ZCjImxaKBC4uPDaihc7JmlMdC1cz3mYWzX09to.png"; // Новая иконка
const popupIcon = "https://iimg.su/s/20/gAVLBWCxVnvIUMz9ynbUbanhNSZljD6AOKod42GV.gif";
let userMarker = null;
let otherMarkers = [];
const proximityThreshold = 500;

// Переменная для хранения разрешения на звук
let soundEnabled = false;
// Аудио контекст для воспроизведения звука
let audioContext = null;
let currentAudio = null; // Для хранения текущего аудио

// Функция для воспроизведения звука уведомления
function playNotificationSound() {
    if (!soundEnabled) return;
    
    // Останавливаем предыдущий звук, если он играет
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    
    // Создаем новый аудио элемент
    currentAudio = new Audio("http://huawei14001a-svg.github.io/soundsNEW/Kaaraudio.mp3");
    currentAudio.play().catch(e => console.log("Ошибка воспроизведения звука:", e));
}

// Функция для остановки звука уведомления
function stopNotificationSound() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
}

// Функция для показа модального окна разрешения звука
function showSoundPermissionModal() {
    const modal = document.getElementById('soundPermissionModal');
    modal.style.display = 'flex';
    
    // Обработчики для кнопок ДА/НЕТ
    document.querySelector('.sound-btn.yes').onclick = function() {
        soundEnabled = true;
        modal.style.display = 'none';
    };
    
    document.querySelector('.sound-btn.no').onclick = function() {
        soundEnabled = false;
        modal.style.display = 'none';
    };
}

// Функция для показа модального окна подтверждения добавления ДПС
function showConfirmDpsModal() {
    const modal = document.getElementById('confirmDpsModal');
    modal.style.display = 'flex';
    
    // Обработчики для кнопок ДА/НЕТ
    document.querySelector('#confirmDpsModal .confirm-btn.yes').onclick = function() {
        modal.style.display = 'none';
        addDpsToDatabase();
    };
    
    document.querySelector('#confirmDpsModal .confirm-btn.no').onclick = function() {
        modal.style.display = 'none';
    };
}

// Функция для добавления ДПС в базу данных
function addDpsToDatabase() {
    if (!userMarker) {
        alert("Геолокация не определена!");
        return;
    }
    
    const latlng = userMarker.getLatLng();
    const dpsData = {
        lat: latlng.lat,
        lng: latlng.lng,
        pic: "https://s.iimg.su/s/03/gnVFlXXxHc8QwpUhCrN5np4I8u8BeteLdtNqpPNk.gif",
        name: "ДПС"
    };
    
    fetch(tableUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'xc-token': token
        },
        body: JSON.stringify(dpsData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка сети');
        }
        return response.json();
    })
    .then(data => {
        showCenterNotification("ДПС успешно добавлено!", "Успех");
        
        // Добавляем маркер на карту
        const markerImageUrl = dpsData.pic;
        const randomRotation = getRandomRotation();
        const customIcon = createCustomIcon(markerImageUrl, false, randomRotation);
        
        const leafletMarker = L.marker([dpsData.lat, dpsData.lng], { icon: customIcon })
            .addTo(map)
            .on('click', function(e) {
                e.originalEvent.stopPropagation();
                
                document.getElementById('centerNotification').classList.remove('active');
                document.getElementById('markerPopup').classList.remove('active');
                
                showMarkerPopup(dpsData);
            });
        
        otherMarkers.push({ 
            lat: dpsData.lat, 
            lng: dpsData.lng, 
            name: dpsData.name,
            id_name: "",
            rotation: randomRotation
        });
    })
    .catch(error => {
        console.error("Ошибка добавления ДПС:", error);
        showCenterNotification("Ошибка при добавлении ДПС", "Ошибка");
    });
}

// Функция для создания кастомной иконки
function createCustomIcon(url, isUser = false, rotation = 0) {
    const size = isUser ? 60 : 32; // Для пользователя увеличен размер на 20 пикселей
    const rotationStyle = rotation !== 0 ? `transform: rotate(${rotation}deg);` : '';
    
    // Для пользовательской иконки изменяем якорь, чтобы нижний край был привязан к геопозиции
    const iconAnchor = isUser ? [size/2, size] : [size/2, size/2];
    
    return L.divIcon({
        className: 'custom-marker',
        html: `<img src="${url}" class="marker-icon ${isUser ? 'user-marker' : ''}" style="width: ${size}px; height: ${size}px; ${rotationStyle}">`,
        iconSize: [size, size],
        iconAnchor: iconAnchor // Для пользователя якорь внизу по центру
    });
}

function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function showNotification(message) {
    const notif = document.getElementById('proximityNotification');
    notif.innerText = message;
    notif.style.display = 'flex';
    setTimeout(() => { notif.style.display = 'none'; }, 3000);
}

// Функция для показа центрального уведомления для comm маркеров
function showCenterNotification(message, title = "Уведомление") {
    const centerNotif = document.getElementById('centerNotification');
    const titleElement = document.getElementById('centerNotificationTitle');
    const messageElement = document.getElementById('centerNotificationMessage');
    
    titleElement.textContent = title;
    messageElement.textContent = message;
    centerNotif.classList.add('active');
    
    // Воспроизводим звук уведомления
    playNotificationSound();
}

// Функция для показа попапа маркера
function showMarkerPopup(markerData) {
    const popup = document.getElementById('markerPopup');
    const titleElement = document.getElementById('markerPopupTitle');
    const messageElement = document.getElementById('markerPopupMessage');
    
    titleElement.textContent = markerData.name || "ДПС";
    messageElement.textContent = `Координаты: ${markerData.lat.toFixed(6)}, ${markerData.lng.toFixed(6)}`;
    
    popup.classList.add('active');
}

// Закрытие центрального уведомления по кнопке
document.querySelector('#centerNotification .notification-close').addEventListener('click', function() {
    document.getElementById('centerNotification').classList.remove('active');
    // Останавливаем звук при закрытии уведомления
    stopNotificationSound();
});

// Закрытие попапа маркера по кнопке
document.querySelector('#markerPopup .popup-close').addEventListener('click', function() {
    document.getElementById('markerPopup').classList.remove('active');
    // Останавливаем звук при закрытии попапа
    stopNotificationSound();
});

// Закрытие уведомлений по клику вне их
document.addEventListener('click', function(event) {
    const centerNotif = document.getElementById('centerNotification');
    const markerPopup = document.getElementById('markerPopup');
    
    if (centerNotif.classList.contains('active') && !centerNotif.contains(event.target)) {
        centerNotif.classList.remove('active');
        // Останавливаем звук при закрытии уведомления
        stopNotificationSound();
    }
    
    if (markerPopup.classList.contains('active') && !markerPopup.contains(event.target)) {
        markerPopup.classList.remove('active');
        // Останавливаем звук при закрытии попапа
        stopNotificationSound();
    }
});

// Объект для отслеживания уже уведомленных маркеров
const notifiedMarkers = {};

function checkProximity(lat, lng) {
    otherMarkers.forEach(m => {
        if (m.id_name === "comm") return;
        
        const distance = getDistanceFromLatLonInMeters(lat, lng, m.lat, m.lng);
        const markerKey = `${m.lat.toFixed(6)}_${m.lng.toFixed(6)}`;
        
        if (distance < proximityThreshold && !notifiedMarkers[markerKey]) {
            // Помечаем маркер как уведомленный
            notifiedMarkers[markerKey] = true;
            
            showNotification(`Вы рядом с меткой "${m.name}"!`);
            showCenterNotification(`Вы находитесь рядом с ДПС! Расстояние: ${Math.round(distance)} метров`, "ДПС рядом!");
        }
    });
}

// Функция для генерации случайного угла вращения
function getRandomRotation() {
    return Math.floor(Math.random() * 0);
}

// Загрузка маркеров из базы
fetch(tableUrl, { headers: { "xc-token": token } })
.then(res => res.json())
.then(data => {
    data.list.forEach(marker => {
        if(marker.lat && marker.lng){
            const markerImageUrl = marker.pic || "https://iimg.su/s/20/giTwje7xhv9YlqNoULTJHDO1NT8Ce2SJKhqMG53H.png";
            
            const randomRotation = getRandomRotation();
            const customIcon = createCustomIcon(markerImageUrl, false, randomRotation);
            
            const leafletMarker = L.marker([marker.lat, marker.lng], { icon: customIcon })
                .addTo(map)
                .on('click', function(e) {
                    e.originalEvent.stopPropagation();
                    
                    document.getElementById('centerNotification').classList.remove('active');
                    document.getElementById('markerPopup').classList.remove('active');
                    
                    if (marker.id_name === "comm") {
                        showCenterNotification(marker.name, "Комментарий");
                    } else {
                        showMarkerPopup(marker);
                    }
                });
            
            otherMarkers.push({ 
                lat: marker.lat, 
                lng: marker.lng, 
                name: marker.name || "ДПС",
                id_name: marker.id_name || "",
                rotation: randomRotation
            });
        }
    });
})
.catch(err => console.error("Ошибка загрузки маркеров:", err));

// Закрытие попапов при клике на карту
map.on('click', function() {
    document.getElementById('centerNotification').classList.remove('active');
    document.getElementById('markerPopup').classList.remove('active');
    // Останавливаем звук при клике на карту
    stopNotificationSound();
});

document.getElementById("geoButton").addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Геолокация не поддерживается вашим браузером."); return; }

    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if (!userMarker) {
            const customIcon = createCustomIcon(userIcon, true);
            userMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            map.flyTo([lat, lng], 15);
        }

        // Показываем кнопку добавления ДПС
        document.getElementById("addDpsButton").style.display = "block";
        
        showSoundPermissionModal();

        checkProximity(lat, lng);

        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            userMarker.setLatLng([lat, lng]);
            checkProximity(lat, lng);
        }, err => console.error("Ошибка геолокации:", err), { enableHighAccuracy: true, maximumAge: 0 });

    }, err => console.error("Ошибка геолокации:", err), { enableHighAccuracy: true });

    document.getElementById("geoButton").style.display = "none";
});

// Обработчик кнопки добавления ДПС
document.getElementById("addDpsButton").addEventListener("click", () => {
    if (!userMarker) {
        alert("Сначала разрешите геолокацию!");
        return;
    }
    
    showConfirmDpsModal();
});
</script>
</body>
</html>